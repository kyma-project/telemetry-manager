name: PR Self-Monitor Tests

permissions:
  contents: read

on:
  pull_request:
    branches:
      - "main"
      - "release-*"
    paths:
      - "**/go.mod"
      - "**/go.sum"
      - "**.go"
      - "!**_test.go"
      - "!docs/**"
      - "test/selfmonitor/**.go"
      - "test/testkit/**.go"
      - "internal/selfmonitor/**"
      - "internal/reconciler/**/status.go"
      - "dependencies/telemetry-self-monitor/**"
      - ".github/workflows/pr-selfmonitor.yml"
      - ".env"
      - ".k3d-kyma.yaml"
      - "Makefile"

  workflow_dispatch:
    inputs:
      kind:
        description: "Signal type to test (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - fluent-bit
          - log-agent
          - log-gateway
          - metric-gateway
          - metric-agent
          - traces
      scenario:
        description: "Scenario to test (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - healthy
          - backpressure
          - outage

env:
  MANAGER_IMAGE: telemetry-manager:pr-${{ github.event.pull_request.number || github.run_id }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build manager image
        run: |
          docker build -t ${{ env.MANAGER_IMAGE }} .

      - name: Save manager image
        run: |
          docker save ${{ env.MANAGER_IMAGE }} > manager-image.tar

      - name: Upload manager image artifact
        uses: actions/upload-artifact@v4
        with:
          name: manager-image
          path: manager-image.tar
          retention-days: 1

  selfmonitor:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        kind:
          - fluent-bit
          - log-agent
          - log-gateway
          - metric-gateway
          - metric-agent
          - traces
        scenario:
          - healthy
          - backpressure
          - outage
    name: "${{ matrix.kind }}-${{ matrix.scenario }}"
    runs-on: ubuntu-latest
    # Skip if workflow_dispatch specified a different kind/scenario
    if: |
      (github.event_name != 'workflow_dispatch') ||
      (github.event.inputs.kind == '' || github.event.inputs.kind == matrix.kind) &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == matrix.scenario)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install tools
        run: |
          # Install k3d
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          # Install gotestsum
          go install gotest.tools/gotestsum@latest

      - name: Download manager image artifact
        uses: actions/download-artifact@v4
        with:
          name: manager-image

      - name: Load manager image
        run: |
          docker load < manager-image.tar

      - name: Provision K3D cluster
        run: |
          k3d cluster create --config .k3d-kyma.yaml
          kubectl create ns kyma-system

      - name: Import manager image to K3D
        run: |
          k3d image import ${{ env.MANAGER_IMAGE }} -c kyma

      - name: Install Istio
        if: ${{ matrix.scenario != 'healthy' }}
        run: |
          hack/deploy-istio.sh

      - name: Deploy manager
        run: |
          if [[ "${{ matrix.kind }}" == "fluent-bit" ]]; then
            make deploy-no-fips MANAGER_IMAGE=${{ env.MANAGER_IMAGE }}
          else
            make deploy MANAGER_IMAGE=${{ env.MANAGER_IMAGE }}
          fi

      - name: Deploy test prerequisites
        run: |
          kubectl apply -f test/fixtures/operator_v1beta1_telemetry.yaml -n kyma-system
          kubectl apply -f test/fixtures/networkpolicy-deny-all.yaml -n kyma-system
          kubectl apply -f test/fixtures/shoot_info_cm.yaml

      - name: Wait for manager to be ready
        run: |
          kubectl -n kyma-system rollout status deployment telemetry-manager --timeout=90s
          kubectl -n kyma-system wait pods -l app.kubernetes.io/instance=telemetry,app.kubernetes.io/name=manager --for=condition=Ready=true --timeout=90s

      - name: Run self-monitor tests
        run: |
          gotestsum --format pkgname --junitfile junit-report-selfmonitor-${{ matrix.kind }}-${{ matrix.scenario }}.xml \
            -- -timeout=20m ./test/selfmonitor/... \
            -- -labels="selfmonitor-${{ matrix.kind }}-${{ matrix.scenario }}"

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: selfmonitor-${{ matrix.kind }}-${{ matrix.scenario }}-report
          path: junit-report*.xml

      - name: Collect failure diagnostics
        if: ${{ failure() }}
        run: |
          echo "=== Manager Pod Description ==="
          kubectl -n kyma-system describe pod -l "app.kubernetes.io/instance=telemetry,app.kubernetes.io/name=manager" || true
          echo ""
          echo "=== Manager Logs ==="
          kubectl -n kyma-system logs -l "app.kubernetes.io/instance=telemetry,app.kubernetes.io/name=manager" --tail=100 || true
          echo ""
          echo "=== Self-Monitor Logs ==="
          kubectl -n kyma-system logs -l "app.kubernetes.io/name=telemetry-self-monitor" --tail=100 || true
          echo ""
          echo "=== Fluent Bit Logs ==="
          kubectl -n kyma-system logs -l "app.kubernetes.io/name=fluent-bit" --tail=100 || true
          echo ""
          echo "=== All Pods ==="
          kubectl get pods -A
