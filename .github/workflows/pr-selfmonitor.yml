name: PR Self-Monitor Tests

permissions:
  contents: read

on:
  pull_request:
    branches:
      - "main"
      - "release-*"
    paths:
      - "**/go.mod"
      - "**/go.sum"
      - "**.go"
      - "!**_test.go"
      - "!docs/**"
      - "test/selfmonitor/**.go"
      - "test/testkit/**.go"
      - "internal/selfmonitor/**"
      - "internal/reconciler/**/status.go"
      - "dependencies/telemetry-self-monitor/**"
      - ".github/workflows/pr-selfmonitor.yml"
      - ".github/template/**"
      - ".env"
      - ".k3d-kyma.yaml"
      - "Makefile"

  workflow_dispatch:
    inputs:
      kind:
        description: "Signal type to test (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - fluent-bit
          - log-agent
          - log-gateway
          - metric-gateway
          - metric-agent
          - traces
      scenario:
        description: "Scenario to test (leave empty for all)"
        required: false
        type: choice
        options:
          - ""
          - healthy
          - backpressure
          - outage

env:
  MANAGER_IMAGE: telemetry-manager:pr-${{ github.event.pull_request.number || github.run_id }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Golang
        uses: ./.github/template/setup-golang

      - name: Build manager image
        run: |
          docker build -t ${{ env.MANAGER_IMAGE }} .

      - name: Save manager image
        run: |
          docker save ${{ env.MANAGER_IMAGE }} > manager-image.tar

      - name: Upload manager image artifact
        uses: actions/upload-artifact@v4
        with:
          name: manager-image
          path: manager-image.tar
          retention-days: 1

  selfmonitor:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        kind:
          - fluent-bit
          - log-agent
          - log-gateway
          - metric-gateway
          - metric-agent
          - traces
        scenario:
          - healthy
          - backpressure
          - outage
    name: "${{ matrix.kind }}-${{ matrix.scenario }}"
    runs-on: ubuntu-latest
    # Skip if workflow_dispatch specified a different kind/scenario
    if: |
      (github.event_name != 'workflow_dispatch') ||
      (github.event.inputs.kind == '' || github.event.inputs.kind == matrix.kind) &&
      (github.event.inputs.scenario == '' || github.event.inputs.scenario == matrix.scenario)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Golang
        uses: ./.github/template/setup-golang

      - name: Download manager image artifact
        uses: actions/download-artifact@v4
        with:
          name: manager-image

      - name: Load manager image
        run: |
          docker load < manager-image.tar

      - name: Provision K3D cluster
        run: |
          make provision-k3d

      - name: Import manager image to K3D
        run: |
          k3d image import ${{ env.MANAGER_IMAGE }} -c kyma

      - name: Install Istio
        if: ${{ matrix.scenario != 'healthy' }}
        run: |
          hack/deploy-istio.sh

      - name: Deploy manager
        run: |
          DEPLOY_TARGET="deploy"
          if [[ "${{ matrix.kind }}" == "fluent-bit" ]]; then
            DEPLOY_TARGET="deploy-no-fips"
          fi
          make $DEPLOY_TARGET MANAGER_IMAGE=${{ env.MANAGER_IMAGE }}

      - name: Deploy test prerequisites
        run: |
          make deploy-test-prerequisites

      - name: Wait for manager to be ready
        run: |
          kubectl -n kyma-system rollout status deployment telemetry-manager --timeout=90s
          kubectl -n kyma-system wait pods -l app.kubernetes.io/instance=telemetry,app.kubernetes.io/name=manager --for=condition=Ready=true --timeout=90s

      - name: Run self-monitor tests
        run: |
          make run-e2e
        env:
          TEST_ID: selfmonitor-${{ matrix.kind }}-${{ matrix.scenario }}
          TEST_PATH: ./test/selfmonitor/...
          TEST_LABELS: "selfmonitor-${{ matrix.kind }}-${{ matrix.scenario }}"

      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: selfmonitor-${{ matrix.kind }}-${{ matrix.scenario }}-report
          path: junit-report*.xml

      - name: Collect failure diagnostics
        if: ${{ failure() }}
        run: |
          echo "=== Manager Pod Description ==="
          kubectl -n kyma-system describe pod -l "app.kubernetes.io/instance=telemetry,app.kubernetes.io/name=manager" || true
          echo ""
          echo "=== Manager Logs ==="
          kubectl -n kyma-system logs -l "app.kubernetes.io/instance=telemetry,app.kubernetes.io/name=manager" --tail=100 || true
          echo ""
          echo "=== Self-Monitor Logs ==="
          kubectl -n kyma-system logs -l "app.kubernetes.io/name=telemetry-self-monitor" --tail=100 || true
          echo ""
          echo "=== Fluent Bit Logs ==="
          kubectl -n kyma-system logs -l "app.kubernetes.io/name=fluent-bit" --tail=100 || true
          echo ""
          echo "=== All Pods ==="
          kubectl get pods -A
