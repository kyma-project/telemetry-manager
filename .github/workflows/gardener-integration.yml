name: Gardener Integration

permissions:
  contents: read
  pull-requests: read

on:
  push:
    branches:
      - "main"
      - "release-*"
    paths-ignore:
      - "docs/**"
      - "dependencies/**"
      - "**/*.md"
      - "OWNERS"
      - "CODEOWNERS"
      - "external-images.yaml"
  # in the pr trigger we need to check if a certain label is present to run the gardener tests: `test-on-gardener`
  pull_request_target:
    types: [labeled, opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      run-gardener-tests: ${{ steps.check-label.outputs.run-gardener-tests }}
    steps:
      - name: Check if gardener tests should run
        id: check-label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TRIGGER_LABEL="test-on-gardener"
          
          echo "Trigger label: $TRIGGER_LABEL"
          
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            echo "PR event detected"
            LABELS=$(gh pr view ${{ github.event.number }} --repo ${{ github.repository }} --json labels --template '{{range .labels}}{{.name}} {{end}}')
            echo "Labels on PR: $LABELS"
            if [[ "$LABELS" == *"$TRIGGER_LABEL"* ]]; then
              echo "Label '$TRIGGER_LABEL' found. Gardener tests will run."
              echo "run-gardener-tests=true" >> $GITHUB_OUTPUT
            else
              echo "Label '$TRIGGER_LABEL' not found. Skipping gardener tests."
              echo "run-gardener-tests=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Not a PR event. Gardener tests will run."
            echo "run-gardener-tests=true" >> $GITHUB_OUTPUT
          fi
  gardener-integration-test:
    needs: check-trigger
    if: needs.check-trigger.outputs.run-gardener-tests == 'true'
    strategy:
      fail-fast: false # if one version is not working, continue tests on other versions
      matrix:
        k8s_version: [1.33,1.34]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Golang
        uses: "./.github/template/setup-golang"

      - name: Prepare environment variables
        env:
          GITHUB_PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
            # For PR events, use dev image with PR number
            PR_NUMBER="${{ github.event.number }}"
            TAG="$GITHUB_PR_HEAD_REF"
            MANAGER_IMAGE="europe-docker.pkg.dev/kyma-project/dev/telemetry-manager:${TAG}"
            echo "Using dev image for PR: $MANAGER_IMAGE"
          else
            # For push events, use prod image with commit-based tag
            GIT_COMMIT_SHA=$(git rev-parse --short=8 HEAD)
            GIT_COMMIT_DATE=$(git show -s --format=%cd --date=format:'v%Y%m%d' $GIT_COMMIT_SHA)
            TAG="$GIT_COMMIT_DATE-$GIT_COMMIT_SHA"
            MANAGER_IMAGE="europe-docker.pkg.dev/kyma-project/prod/telemetry-manager:$TAG"
            echo "Using prod image: $MANAGER_IMAGE"
          fi

          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "MANAGER_IMAGE=$MANAGER_IMAGE" >> $GITHUB_ENV

      # wait for the build to succeed so that the manager image is available
      - name: Wait for the image to be available in the registry
        run: "./hack/await_image.sh"
        env:
          IMAGE_REPO: "${{ github.event_name == 'pull_request_target' && 'europe-docker.pkg.dev/kyma-project/dev/telemetry-manager' || 'europe-docker.pkg.dev/kyma-project/prod/telemetry-manager' }}"
          IMAGE_TAG: "${{ env.TAG }}"
          QUERY_INTERVAL: 30

      # save gardener kubeconfig to a temp file in order to pass it to the command
      - name: Save service account to file
        shell: bash
        run: 'echo "$GARDENER_SA" > /tmp/gardener-sa.yaml'
        env:
          GARDENER_SA: ${{ secrets.GARDENER_SA }}

      - name: Provision Gardener
        run: make provision-gardener
        env:
          GARDENER_SECRET_NAME: ${{ secrets.GARDENER_SECRET_NAME }}
          GARDENER_PROJECT: ${{ secrets.GARDENER_PROJECT }}
          GARDENER_SA_PATH: /tmp/gardener-sa.yaml
          GARDENER_K8S_VERSION: ${{ matrix.k8s_version }}

      - name: Deploy module release
        shell: bash
        run: make --debug deploy-no-fips

      - name: Wait for manager deployment rollout
        shell: bash
        run: kubectl -n kyma-system rollout status deployment telemetry-manager --timeout=90s

      - name: Wait for manager to be ready
        shell: bash
        run: kubectl -n kyma-system wait pods -l app.kubernetes.io/instance=telemetry,app.kubernetes.io/name=manager --for=condition=Ready=true --timeout=90s

      - name: Print cluster info
        shell: bash
        run: |
          kubectl cluster-info
          kubectl -n kyma-system get po

      - name: Deploy Istio
        shell: bash
        run: hack/deploy-istio.sh

      - name: Create Telemetry CR
        shell: bash
        run: kubectl apply -f test/fixtures/operator_v1beta1_telemetry.yaml -n kyma-system

      # Deploying  a deny-all Network Policy to simulate a typical setup on a Kyma cluster
      - name: Create Network Policy
        shell: bash
        run: kubectl apply -f test/fixtures/networkpolicy-deny-all.yaml -n kyma-system

      - name: Execute istio tests subset
        uses: "./.github/template/test-execute"
        with:
          id: gardener-istio
          path: ./test/integration/...
          labels: "gardener"

      - name: Execute e2e tests subset
        uses: "./.github/template/test-execute"
        with:
          id: gardener-e2e
          path: ./test/e2e/...
          labels: "gardener"

      - name: Deprovision gardener cluster
        shell: bash
        if: ${{ !cancelled() }}
        run: make deprovision-gardener
        env:
          GARDENER_SA_PATH: /tmp/gardener-sa.yaml
          GARDENER_K8S_VERSION: ${{ matrix.k8s_version }}

      - name: Upload JUnit report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ !cancelled() }}
        with:
          name: ${{ github.job }}-${{ matrix.k8s_version }}-report
          path: junit-report*.xml

      - name: Send slack message on failure
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        if: failure()
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: ""
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "Workflow <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|*Telemetry ${{ github.workflow }}*> has status *${{ job.status }}*"
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "See related <${{ github.event.pull_request.html_url || github.event.head_commit.url }}|commit>"

  summary:
    needs: [check-trigger, gardener-integration-test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        if: needs.check-trigger.outputs.run-gardener-tests == 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate test summary
        if: needs.check-trigger.outputs.run-gardener-tests == 'true'
        uses: "./.github/template/test-summary"

      - name: Check workflow status
        run: |
          if [[ "${{ needs.check-trigger.outputs.run-gardener-tests }}" == "false" ]]; then
            echo "✓ Gardener tests were skipped (no 'test-gardener' label found)"
            exit 0
          elif [[ "${{ needs.gardener-integration-test.result }}" == "success" ]]; then
            echo "✓ Gardener tests passed successfully"
            exit 0
          elif [[ "${{ needs.gardener-integration-test.result }}" == "skipped" ]]; then
            echo "✓ Gardener tests were skipped"
            exit 0
          else
            echo "✗ Gardener tests failed"
            exit 1
          fi

