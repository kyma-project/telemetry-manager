name: PR Integration

permissions:
  contents: read

on:
  schedule:
    # Run every 3 hours on main branch
    - cron: "0 */3 * * *"
  merge_group:
  pull_request:
    branches:
      - "main"
      - "release-*"
    paths:
      - "**/go.mod"
      - "**/go.sum"
      - "**.go"
      - "config/**"
      - "!config/busola/**"
      - "!**_test.go"
      - "!docs/**"
      - "test/**.go"
      - ".github/workflows/pr-integration.yml"
      - ".github/template/**"
      - ".env"
      - ".k3d-kyma.yaml"
      - "Makefile"
      - "hack/make/*.mk"
      - "helm/**"

  workflow_dispatch:

env:
  E2E_TEST_TIMEOUT: 60m

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      manager-image: ${{ steps.set-env.outputs.manager-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Golang
        uses: ./.github/template/setup-golang

      - name: Prepare environment variables
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            IMAGE_REPO="europe-docker.pkg.dev/kyma-project/dev/telemetry-manager"
            IMAGE_TAG="${{ github.event.pull_request.head.sha }}"
          elif [[ "${{ github.event_name }}" == "merge_group" ]]; then
            IMAGE_REPO="europe-docker.pkg.dev/kyma-project/dev/telemetry-manager"
            IMAGE_TAG="${{ github.event.merge_group.head_sha }}"
          else
            IMAGE_REPO="europe-docker.pkg.dev/kyma-project/prod/telemetry-manager"

            GIT_COMMIT_SHA=$(git rev-parse --short=8 HEAD)
            GIT_COMMIT_DATE=$(git show -s --format=%cd --date=format:'v%Y%m%d' $GIT_COMMIT_SHA)
            IMAGE_TAG="$GIT_COMMIT_DATE-$GIT_COMMIT_SHA"
          fi

          MANAGER_IMAGE="$IMAGE_REPO:$IMAGE_TAG"
          echo "manager-image=$MANAGER_IMAGE" >> $GITHUB_OUTPUT
          echo "image-repo=$IMAGE_REPO" >> $GITHUB_OUTPUT
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Manager image: $MANAGER_IMAGE"

      - name: Wait for image to be built
        shell: bash
        run: make wait-for-image
        env:
          IMAGE_REPO: "${{ steps.set-env.outputs.image-repo }}"
          IMAGE_TAG: "${{ steps.set-env.outputs.image-tag }}"
          QUERY_INTERVAL: 30

  e2e:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite:
          - name: e2e-logs
            path: ./test/e2e/logs/...
          - name: e2e-metrics
            path: ./test/e2e/metrics/...
          - name: e2e-traces
            path: ./test/e2e/traces/...
          - name: e2e-misc
            path: ./test/e2e/misc/...
          - name: e2e-upgrade
            path: ./test/e2e/upgrade/...
          - name: integration
            path: ./test/integration/...
    name: ${{ matrix.suite.name }}
    env:
      MANAGER_IMAGE: ${{ needs.setup.outputs.manager-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Golang
        uses: ./.github/template/setup-golang

      - name: Provision K3D cluster
        run: make provision-k3d

      - name: Run ${{ matrix.suite.name }} tests
        run: |
          make e2e-test \
            E2E_TEST_PATH="${{ matrix.suite.path }}" \
            E2E_TEST_ID="${{ matrix.suite.name }}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.suite.name }}-results
          path: junit-report-*.xml

      - name: Print pods on failure
        if: failure()
        run: |
          kubectl get pods -A
          for pod in $(kubectl get pods -n kyma-system -o name 2>/dev/null); do
            echo "=== $pod ==="
            kubectl logs -n kyma-system $pod --all-containers 2>/dev/null || true
          done

  # Selfmonitor tests run in separate jobs as they take a long time
  selfmonitor:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test:
          - name: selfmonitor-healthy
            run: TestHealthy
          - name: selfmonitor-backpressure
            run: TestBackpressure
          - name: selfmonitor-outage
            run: TestOutage
    name: ${{ matrix.test.name }}
    env:
      MANAGER_IMAGE: ${{ needs.setup.outputs.manager-image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Golang
        uses: ./.github/template/setup-golang

      - name: Provision K3D cluster
        run: make provision-k3d

      - name: Run ${{ matrix.test.name }} tests
        run: |
          make e2e-test \
            E2E_TEST_PATH="./test/selfmonitor/..." \
            E2E_TEST_ID="${{ matrix.test.name }}" \
            E2E_TEST_RUN="${{ matrix.test.run }}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test.name }}-results
          path: junit-report-*.xml

      - name: Print pods on failure
        if: failure()
        run: |
          kubectl get pods -A
          for pod in $(kubectl get pods -n kyma-system -o name 2>/dev/null); do
            echo "=== $pod ==="
            kubectl logs -n kyma-system $pod --all-containers 2>/dev/null || true
          done

  summary:
    needs: [e2e, selfmonitor]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
          pattern: "*-results"
          merge-multiple: true

      - name: Generate test summary
        uses: "./.github/template/test-summary"
