name: Test Setup
description: Sets up the test environment and provisions a basic k3d cluster

inputs:
  experimental:
    description: Deploy manager in experimental mode
    required: false
    default: "false"
  github-token:
    description: Github token to use for github access
    required: true
  install-istio:
    description: Whether to install the Istio module
    required: true
    default: "false"
  manager-image:
    description: Telemetry Manager image to be used in tests
    required: true
  operate-in-fips-mode:
    description: Whether components should be deployed in FIPS 140-2 compliant way.
    required: true
    default: "true"
  custom-labels-annotations-no-fips:
    description: Whether to add custom labels and annotations to the components using helm in non-FIPS mode.
    required: false
    default: "false"

runs:
  using: "composite"

  steps:
    - name: Setup Golang
      uses: "./.github/template/setup-golang"

    - name: Provision basic K3D cluster
      shell: bash
      run: |
        echo "::notice title=K3D Cluster::Provisioning basic K3D cluster"
        make provision-k3d

    - name: Set environment variables for tests
      shell: bash
      run: |
        echo "MANAGER_IMAGE=${{ inputs.manager-image }}" >> $GITHUB_ENV
        echo "INSTALL_ISTIO=${{ inputs.install-istio }}" >> $GITHUB_ENV
        echo "ENABLE_EXPERIMENTAL=${{ inputs.experimental }}" >> $GITHUB_ENV
        echo "OPERATE_IN_FIPS_MODE=${{ inputs.operate-in-fips-mode }}" >> $GITHUB_ENV
        echo "CUSTOM_LABELS_ANNOTATIONS=${{ inputs.custom-labels-annotations-no-fips }}" >> $GITHUB_ENV
        echo "::notice title=Test Configuration::Manager Image: ${{ inputs.manager-image }}"
        echo "::notice title=Test Configuration::Install Istio: ${{ inputs.install-istio }}"
        echo "::notice title=Test Configuration::Experimental: ${{ inputs.experimental }}"
        echo "::notice title=Test Configuration::FIPS Mode: ${{ inputs.operate-in-fips-mode }}"
        echo "::notice title=Test Configuration::Custom Labels/Annotations: ${{ inputs.custom-labels-annotations-no-fips }}"
