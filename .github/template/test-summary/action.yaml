name: Test Summary
description: Downloads test artifacts and publishes consolidated test reports

inputs:
  reports-path:
    description: Path where reports will be downloaded
    required: false
    default: "reports"

runs:
  using: "composite"

  steps:
    - name: Install xmlstarlet
      shell: bash
      run: |
        if ! command -v xmlstarlet &> /dev/null; then
          echo "Installing xmlstarlet..."
          sudo apt-get update -qq
          sudo apt-get install -y xmlstarlet
        else
          echo "xmlstarlet is already installed"
        fi

    - name: Download JUnit reports
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      with:
        path: "${{ inputs.reports-path }}"
        pattern: "*-report"
        merge-multiple: true

    # Process each JUnit report XML file to remove testcase elements with zero execution time
    # This removes both skipped tests and tests that didn't actually run
    - name: Clean-up JUnit reports
      shell: bash
      run: |
        for xml_file in ${{ inputs.reports-path }}/*.xml; do
          if [ -f "$xml_file" ]; then
            echo "Processing: $xml_file"
            xmlstarlet ed -L --delete "//testcase[starts-with(@time, '0.0')]" "$xml_file"
            echo "âœ“ Removed zero-time testcases from: $xml_file"
          fi
        done

    - name: Publish JUnit reports as GHA Summary
      uses: mikepenz/action-junit-report@5b7ee5a21e8674b695313d769f3cbdfd5d4d53a4 # v6.0.0
      if: always()
      with:
        report_paths: "${{ inputs.reports-path }}/junit-report*.xml"
        summary: true
        detailed_summary: true
        fail_on_failure: true
        include_passed: true
        skip_annotations: true
        group_suite: true
        include_empty_in_summary: false
        include_time_in_summary: true
